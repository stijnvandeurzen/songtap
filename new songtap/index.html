<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SongTap â€“ Spotify Login</title>
</head>
<body>
  <h1>ðŸŽµ SongTap â€“ Login with Spotify</h1>
  <button id="login-button">Log in with Spotify</button>

  <script>
    // Generate a random string of given length (PKCE code verifier):contentReference[oaicite:5]{index=5}.
    function generateVerifier(length) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      const randomValues = crypto.getRandomValues(new Uint8Array(length));
      randomValues.forEach(val => { result += chars[val % chars.length]; });
      return result;
    }
    // Compute SHA-256 hash and encode in Base64-url (PKCE code challenge):contentReference[oaicite:6]{index=6}.
    async function generateChallenge(verifier) {
      const encoder = new TextEncoder();
      const hashBuffer = await crypto.subtle.digest('SHA-256', encoder.encode(verifier));
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const base64String = btoa(String.fromCharCode(...hashArray))
        .replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
      return base64String;
    }

    document.getElementById('login-button').addEventListener('click', async () => {
      const verifier = generateVerifier(128);
      const challenge = await generateChallenge(verifier);
      localStorage.setItem('pkce_verifier', verifier);

      // Build Spotify authorize URL with PKCE parameters
      const params = new URLSearchParams({
        client_id: 'd9469dc4e627498e8c23ab7641069b15',
        response_type: 'code',
        redirect_uri: 'https://song-tap.com/callback.html',
        code_challenge_method: 'S256',
        code_challenge: challenge,
        scope: 'user-read-playback-state user-read-currently-playing playlist-read-private user-modify-playback-state'
      });
      window.location = 'https://accounts.spotify.com/authorize?' + params.toString();
    });
  </script>
</body>
</html>
